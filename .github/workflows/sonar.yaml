name: SonarCloud Analysis

#push: [main]
on:
  push:
  pull_request:

jobs:
  build-and-test:
    runs-on: macos-latest
    env:
      CC: clang
      CXX: clang++
      CCACHE_DIR: ${{ github.workspace }}/.ccache
      CCACHE_MAXSIZE: 500M
      VCPKG_DEFAULT_TRIPLET: arm64-osx

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      # 2ï¸âƒ£ Setup ccache
      - uses: hendrikmuhs/ccache-action@v1
        with:
          key: ${{ runner.os }}-build-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-build-
          max-size: 500M

      # 3ï¸âƒ£ Install Xcode CLI tools
      - name: Install Xcode CLI tools
        run: xcode-select --install || true

      # 4ï¸âƒ£ Install system dependencies
      - name: Install system dependencies
        run: |
          set -eux
          brew update
          brew install cmake ninja autoconf autoconf-archive automake libtool ccache lcov clang-format rabbitmq-c wget unzip gcovr

      - name: Remove Homebrew protobuf (force vcpkg)
        run: |
          brew uninstall --ignore-dependencies protobuf || true

      # 5ï¸âƒ£ Bootstrap vcpkg
      - name: Bootstrap vcpkg
        run: ./external/vcpkg/bootstrap-vcpkg.sh -disableMetrics

      # 6ï¸âƒ£ vcpkg binary cache only
      - name: Cache vcpkg binaries
        uses: actions/cache@v4
        with:
          path: vcpkg-cache
          key: vcpkg-${{ runner.os }}-${{ env.VCPKG_DEFAULT_TRIPLET }}
          restore-keys: |
            vcpkg-${{ runner.os }}-${{ env.VCPKG_DEFAULT_TRIPLET }}

      - name: Setup vcpkg binary cache
        run: echo "VCPKG_BINARY_SOURCES=clear;files,${{ github.workspace }}/vcpkg-cache,readwrite" >> $GITHUB_ENV

      - name: Install Sonar build-wrapper (macOS)
        run: |
          mkdir -p $HOME/sonar
          cd $HOME/sonar
          curl -fL -o bw.zip https://sonarcloud.io/static/cpp/build-wrapper-macosx-x86.zip
          unzip -q bw.zip
          chmod +x build-wrapper-macosx-x86/build-wrapper-macosx-x86

      - name: Debug Sonar build wrapper
        run: |
          echo "HOME/sonar=$HOME/sonar"
          ls -R $HOME/sonar

      # 8ï¸âƒ£ Configure CMake
      - name: Configure CMake
        run: |
          rm -rf build
          cmake -S . -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_OSX_ARCHITECTURES=arm64 \
            -DENABLE_COVERAGE=ON \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
            -DCMAKE_TOOLCHAIN_FILE=$PWD/external/vcpkg/scripts/buildsystems/vcpkg.cmake \
            -DVCPKG_TARGET_TRIPLET=arm64-osx \
            -DTRACY_ENABLE=ON \
            -Wno-dev

      - name: Build project with Build Wrapper
        run: |
          $HOME/sonar/build-wrapper-macosx-x86/build-wrapper-macosx-x86 \
            --out-dir bw-output \
            cmake --build build -- -j$(sysctl -n hw.ncpu)

      # ðŸ”Ÿ Run tests
      - name: Run tests
        run: ctest --test-dir build --output-on-failure


      - name: Generate coverage report
        run: |
          gcovr -r . --sonarqube -o coverage.xml

      # 5ï¸âƒ£ Run SonarCloud scan
      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@v2
        with:
          organization: "roma3214185"
          projectKey: "roma3214185"
          projectBaseDir: .
          token: ${{ secrets.SONAR_TOKEN }}
          extraProperties: |
            sonar.cfamily.build-wrapper-output=bw-output
            sonar.coverageReportPaths=coverage.xml



# jobs:
#   sonarcloud:
#     name: Upload to SonarCloud
#     runs-on: ubuntu-22.04
#     if: github.event.workflow_run.conclusion == 'success' && github.repository_owner == 'apache'
#     steps:
#       - uses: actions/checkout@v4
#         with:
#           repository: ${{ github.event.workflow_run.head_repository.full_name }}
#           ref: ${{ github.event.workflow_run.head_sha }}
#           fetch-depth: 0
#       - name: Install Build Wrapper
#         uses: SonarSource/sonarqube-scan-action/install-build-wrapper@v6.0.0
#       - name: 'Download code coverage'
#         uses: actions/github-script@v7
#         with:
#           script: |
#             let allArtifacts = await github.rest.actions.listWorkflowRunArtifacts({
#                owner: context.repo.owner,
#                repo: context.repo.repo,
#                run_id: context.payload.workflow_run.id,
#             });
#             let matchArtifact = allArtifacts.data.artifacts.filter((artifact) => {
#               return artifact.name == "sonarcloud-data"
#             })[0];
#             let download = await github.rest.actions.downloadArtifact({
#                owner: context.repo.owner,
#                repo: context.repo.repo,
#                artifact_id: matchArtifact.id,
#                archive_format: 'zip',
#             });
#             let fs = require('fs');
#             fs.writeFileSync(`${process.env.GITHUB_WORKSPACE}/sonarcloud-data.zip`, Buffer.from(download.data));
#       - name: 'Unzip code coverage'
#         run: |
#           unzip sonarcloud-data.zip
#           mv _build build
#           mkdir -p build/CMakeFiles/CMakeTmp
#           ls -a sonarcloud-data build

#       - uses: actions/setup-python@v5
#         with:
#           python-version: 3.x

#       - name: Extract PR number
#         run: |
#           PR_NUMBER=$(jq -r '.number | select (.!=null)' sonarcloud-data/github-event.json)
#           echo "PR_NUMBER=$PR_NUMBER" >> "$GITHUB_ENV"
#           echo "The PR number is ${PR_NUMBER:-<none>}"

#       - name: SonarQube Scan
#         uses: SonarSource/sonarqube-scan-action@v6.0.0
#         env:
#           GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
#           SONAR_TOKEN: ${{ secrets.SONARCLOUD_TOKEN }}
#         with:
#           args: >
#             -Dsonar.cfamily.build-wrapper-output=sonarcloud-data
#             -Dsonar.coverageReportPaths=sonarcloud-data/coverage.xml
#             -Dsonar.projectKey=apache_kvrocks
#             -Dsonar.organization=apache
#             -Dsonar.scm.revision=${{ github.event.workflow_run.head_sha }}
#             -Dsonar.pullrequest.key=${{ env.PR_NUMBER }}
